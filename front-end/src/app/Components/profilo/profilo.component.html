<div class="container py-5">
  <!-- Messaggio di caricamento -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Caricamento...</span>
    </div>
    <p class="mt-3">Caricamento del profilo in corso...</p>
  </div>

  <!-- Messaggi di feedback -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show my-3" role="alert">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null" aria-label="Close"></button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show my-3" role="alert">
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = null" aria-label="Close"></button>
  </div>

  <!-- Contenuto principale (se non in caricamento) -->
  <div *ngIf="!loading" class="row">
    <!-- Sidebar con tabs -->
    <div class="col-md-3">
      <div class="list-group shadow-sm">
        <button class="list-group-item list-group-item-action d-flex align-items-center"
                [class.active]="activeTab === 'profile'"
                (click)="setActiveTab('profile')">
          <i class="bi bi-person-circle me-2"></i>
          Dati Personali
        </button>
        <button class="list-group-item list-group-item-action d-flex align-items-center"
                [class.active]="activeTab === 'orders'"
                (click)="setActiveTab('orders')">
          <i class="bi bi-box me-2"></i>
          I miei ordini
          <span *ngIf="orders.length > 0" class="badge bg-primary ms-auto">{{ orders.length }}</span>
        </button>
        <button class="list-group-item list-group-item-action d-flex align-items-center"
                [class.active]="activeTab === 'addresses'"
                (click)="setActiveTab('addresses')">
          <i class="bi bi-geo-alt me-2"></i>
          Indirizzi
          <span *ngIf="addresses.length > 0" class="badge bg-primary ms-auto">{{ addresses.length }}</span>
        </button>
        <button class="list-group-item list-group-item-action d-flex align-items-center"
                [class.active]="activeTab === 'payment'"
                (click)="setActiveTab('payment')">
          <i class="bi bi-credit-card me-2"></i>
          Metodi di pagamento
          <span *ngIf="paymentMethods.length > 0" class="badge bg-primary ms-auto">{{ paymentMethods.length }}</span>
        </button>
      </div>
    </div>

    <!-- Area contenuto principale -->
    <div class="col-md-9">
      <!-- Tab Profilo -->
      <div *ngIf="activeTab === 'profile'" class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0">I tuoi dati personali</h5>
          <button class="btn btn-sm"
                  [class.btn-outline-primary]="!editMode"
                  [class.btn-outline-secondary]="editMode"
                  (click)="toggleEditMode()">
            <i class="bi" [class.bi-pencil]="!editMode" [class.bi-x]="editMode"></i>
            {{ editMode ? 'Annulla' : 'Modifica' }}
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="!editMode" class="row">
            <div class="col-md-6">
              <p><strong>Nome:</strong> {{ user?.nome }}</p>
              <p><strong>Cognome:</strong> {{ user?.cognome }}</p>
              <p><strong>Email:</strong> {{ user?.email }}</p>
            </div>
            <div class="col-md-6">
              <p *ngIf="user?.telefono"><strong>Telefono:</strong> {{ user?.telefono }}</p>
              <p *ngIf="user?.username"><strong>Username:</strong> {{ user?.username }}</p>
              <p><strong>Ruolo:</strong> {{ user?.ruolo ? 'Amministratore' : 'Utente' }}</p>
            </div>
          </div>

          <div *ngIf="editMode">
            <form (ngSubmit)="saveUserChanges()">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="nome" class="form-label">Nome*</label>
                  <input type="text" class="form-control" id="nome" [(ngModel)]="editableUser.nome" name="nome" required>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Tab Ordini -->
      <div *ngIf="activeTab === 'orders'" class="card shadow-sm">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">I tuoi ordini</h5>
        </div>
        <div class="card-body">
          <div *ngIf="orders.length === 0" class="text-center py-4">
            <i class="bi bi-bag-x" style="font-size: 3rem; color: #ccc;"></i>
            <p class="mt-3">Non hai ancora effettuato ordini.</p>
            <a routerLink="/catalogo" class="btn btn-primary">Inizia lo shopping</a>
          </div>

          <div *ngIf="orders.length > 0">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                <tr>
                  <th>Ordine #</th>
                  <th>Data</th>
                  <th>Stato</th>
                  <th>Totale</th>
                  <th>Azioni</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let order of orders">
                  <td>{{ order.id }}</td>
                  <td>{{ order.data }}</td>
                  <td>
                      <span class="badge" [ngClass]="{
                        'bg-primary': order.stato === 'IN_ELABORAZIONE',
                        'bg-warning text-dark': order.stato === 'SPEDITO',
                        'bg-success': order.stato === 'CONSEGNATO',
                        'bg-danger': order.stato === 'ANNULLATO'
                      }">{{ order.stato }}</span>
                  </td>
                  <td>€{{ order.totalePagare.toFixed(2) }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" (click)="viewOrderDetails(order.id)">
                      <i class="bi bi-eye me-1"></i> Dettagli
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Indirizzi -->
      <div *ngIf="activeTab === 'addresses'" class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0">I tuoi indirizzi</h5>
          <button class="btn btn-sm btn-outline-primary" (click)="toggleNewAddressForm()">
            <i class="bi" [class.bi-plus]="!showNewAddressForm" [class.bi-x]="showNewAddressForm"></i>
            {{ showNewAddressForm ? 'Annulla' : 'Aggiungi indirizzo' }}
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="addresses.length === 0 && !showNewAddressForm" class="text-center py-4">
            <i class="bi bi-geo-alt" style="font-size: 3rem; color: #ccc;"></i>
            <p class="mt-3">Non hai ancora salvato nessun indirizzo.</p>
          </div>

          <!-- Form per nuovo indirizzo -->
          <div *ngIf="showNewAddressForm" class="mb-4">
            <h6 class="border-bottom pb-2 mb-3">Nuovo indirizzo</h6>
            <form (ngSubmit)="addNewAddress()">
              <div class="row g-3">
                <div class="col-md-8">
                  <label for="nomeVia" class="form-label">Via*</label>
                  <input type="text" class="form-control" id="nomeVia" [(ngModel)]="newAddress.nomeVia" name="nomeVia" required>
                </div>
                <div class="col-md-4">
                  <label for="civico" class="form-label">Civico*</label>
                  <input type="text" class="form-control" id="civico" [(ngModel)]="newAddress.civico" name="civico" required>
                </div>
                <div class="col-md-6">
                  <label for="citta" class="form-label">Città*</label>
                  <input type="text" class="form-control" id="citta" [(ngModel)]="newAddress.citta" name="citta" required>
                </div>
                <div class="col-md-6">
                  <label for="cap" class="form-label">CAP*</label>
                  <input type="text" class="form-control" id="cap" [(ngModel)]="newAddress.cap" name="cap" required>
                </div>
                <div class="col-md-6">
                  <label for="provincia" class="form-label">Provincia*</label>
                  <input type="text" class="form-control" id="provincia" [(ngModel)]="newAddress.provincia" name="provincia" required>
                </div>
                <div class="col-md-6">
                  <label for="regione" class="form-label">Regione*</label>
                  <input type="text" class="form-control" id="regione" [(ngModel)]="newAddress.regione" name="regione" required>
                </div>
                <div class="col-12 mt-3">
                  <button type="submit" class="btn btn-primary">Salva indirizzo</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Lista indirizzi -->
          <div *ngIf="addresses.length > 0" class="row row-cols-1 row-cols-md-2 g-4">
            <div class="col" *ngFor="let address of addresses">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">{{ address.nomeVia }}, {{ address.civico }}</h6>
                  <p class="card-text">
                    {{ address.citta }}, {{ address.cap }}<br>
                    {{ address.provincia }}, {{ address.regione }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Metodi di Pagamento -->
      <div *ngIf="activeTab === 'payment'" class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0">I tuoi metodi di pagamento</h5>
          <button class="btn btn-sm btn-outline-primary" (click)="toggleNewPaymentForm()">
            <i class="bi" [class.bi-plus]="!showNewPaymentForm" [class.bi-x]="showNewPaymentForm"></i>
            {{ showNewPaymentForm ? 'Annulla' : 'Aggiungi metodo' }}
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="paymentMethods.length === 0 && !showNewPaymentForm" class="text-center py-4">
            <i class="bi bi-credit-card" style="font-size: 3rem; color: #ccc;"></i>
            <p class="mt-3">Non hai ancora salvato nessun metodo di pagamento.</p>
          </div>

          <!-- Form per nuovo metodo di pagamento -->
          <div *ngIf="showNewPaymentForm" class="mb-4">
            <h6 class="border-bottom pb-2 mb-3">Nuovo metodo di pagamento</h6>
            <form (ngSubmit)="addNewPaymentMethod()">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="titolare" class="form-label">Titolare della carta*</label>
                  <input type="text" class="form-control" id="titolare" [(ngModel)]="newPaymentMethod.titolare" name="titolare" required>
                </div>
                <div class="col-md-6">
                  <label for="tipoCarta" class="form-label">Tipo di carta*</label>
                  <select class="form-select" id="tipoCarta" [(ngModel)]="newPaymentMethod.tipoCarta" name="tipoCarta" required>
                    <option value="VISA">VISA</option>
                    <option value="MASTERCARD">MasterCard</option>
                    <option value="AMEX">American Express</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="numeroCarta" class="form-label">Numero carta*</label>
                  <input type="text" class="form-control" id="numeroCarta" [(ngModel)]="newPaymentMethod.numeroCarta" name="numeroCarta" placeholder="XXXX XXXX XXXX XXXX" required>
                </div>
                <div class="col-md-3">
                  <label for="dataScadenza" class="form-label">Scadenza*</label>
                  <input type="text" class="form-control" id="dataScadenza" [(ngModel)]="newPaymentMethod.dataScadenza" name="dataScadenza" placeholder="MM/AA" required>
                </div>
                <div class="col-md-3">
                  <label for="cvv" class="form-label">CVV*</label>
                  <input type="text" class="form-control" id="cvv" [(ngModel)]="newPaymentMethod.cvv" name="cvv" placeholder="123" required>
                </div>
                <div class="col-12 mt-3">
                  <button type="submit" class="btn btn-primary">Salva metodo di pagamento</button>
                </div>
              </div>
            </form>
          </div>

          <!-- Lista metodi di pagamento -->
          <div *ngIf="paymentMethods.length > 0" class="row row-cols-1 row-cols-md-2 g-4">
            <div class="col" *ngFor="let method of paymentMethods">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi" [ngClass]="{
                      'bi-credit-card': method.tipoCarta === 'VISA',
                      'bi-credit-card-2-front': method.tipoCarta === 'MASTERCARD',
                      'bi-credit-card-fill': method.tipoCarta === 'AMEX'
                    }" style="font-size: 1.5rem; margin-right: 10px;"></i>
                    <h6 class="card-title mb-0">{{ method.tipoCarta }}</h6>
                  </div>
                  <p class="card-text">
                    {{ method.titolare }}<br>
                    **** **** **** {{ method.numeroCarta.slice(-4) }}<br>
                    Scadenza: {{ method.dataScadenza }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="col-md-6">
  <label for="cognome" class="form-label">Cognome*</label>
  <input type="text" class="form-control" id="cognome" [(ngModel)]="editableUser.cognome" name="cognome" required>
</div>
<div class="col-md-6">
  <label for="email" class="form-label">Email*</label>
  <input type="email" class="form-control" id="email" [(ngModel)]="editableUser.email" name="email" required>
</div>
<div class="col-md-6">
  <label for="telefono" class="form-label">Telefono</label>
  <input type="tel" class="form-control" id="telefono" [(ngModel)]="editableUser.telefono" name="telefono">
</div>
<div class="col-12 mt-4">
  <button type="submit" class="btn btn-primary">
    <i class="bi bi-check2 me-2"></i>Salva modifiche
  </button>
</div>
